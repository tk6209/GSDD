#!/usr/bin/env bash
set -euo pipefail

cmd="${1:-help}"

print_help() {
  cat <<'H'
üõ°Ô∏è  GSDD CLI

Commands:
  gsdd verify <spec.md>     Validate a SPEC file (structure-only) against the GSDD SPEC contract
  gsdd snapshot             Create a snapshot artifact (placeholder)
  gsdd audit                Verify outcome against SPEC (placeholder)
  gsdd help                 Show this help

Rules:
- The CLI never auto-fixes.
- The CLI never auto-heals.
- The CLI never mutates a SPEC.
- The CLI only verifies, blocks, and records.
H
}

# Normalize headings (case-insensitive) and accept common aliases.
# SPEC is expected to be a Markdown document with headings.
verify_spec() {
  local file="${1:-}"
  if [[ -z "$file" ]]; then
    echo "ERROR: Missing SPEC path."
    echo "Usage: gsdd verify <spec.md>"
    exit 2
  fi
  if [[ ! -f "$file" ]]; then
    echo "ERROR: SPEC file not found: $file"
    exit 2
  fi

  # Required canonical sections
  required_keys=(
    "scope"
    "objective"
    "inputs"
    "constraints"
    "expected outcome"
  )

  # Read file once
  content="$(cat "$file")"

  missing=()

  for key in "${required_keys[@]}"; do
    case "$key" in
      "scope")
        re="scope|escopo"
        ;;
      "objective")
        re="objective|objetivo"
        ;;
      "inputs")
        re="inputs|input|entradas"
        ;;
      "constraints")
        re="constraints|constraint|restri(c|√ß)√µes|restricoes"
        ;;
      "expected outcome")
        re="expected outcome|expected results?|outcome|resultado esperado|resultados esperados"
        ;;
    esac

    if ! printf "%s\n" "$content" | LC_ALL=C grep -Eiq \
      '^[[:space:]]{0,3}#{1,6}[[:space:]]+('"$re"')([[:space:]]*/[[:space:]]*('"$re"'))?[[:space:]]*$'
    then
      missing+=("$key")
    fi
  done

  if (( ${#missing[@]} > 0 )); then
    echo "‚ùå SPEC INVALID (missing mandatory sections):"
    for m in "${missing[@]}"; do
      echo "  - $m"
    done
    echo
    echo "STOP: Execution is forbidden by GSDD without a valid SPEC."
    exit 1
  fi

  echo "‚úÖ SPEC VALID (structure-only): $file"
}

case "$cmd" in
  verify)
    shift
    verify_spec "${1:-}"
    ;;
  snapshot)
    echo "üßä snapshot: placeholder (bootstrap)."
    ;;
  audit)
    echo "üß™ audit: placeholder (bootstrap)."
    ;;
  help|--help|-h|"")
    print_help
    ;;
  *)
    echo "ERROR: Unknown command: $cmd"
    echo
    print_help
    exit 2
    ;;
esac
